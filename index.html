<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Moose Feed</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="app">
    <div class="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 p-4 flex items-center justify-center">
      <div class="max-w-2xl w-full">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
          <!-- Header -->
          <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-6 text-white text-center">
            <div class="flex items-center justify-center gap-2 mb-2">
              <svg class="w-7 h-7 fill-current" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
              <h1 class="text-3xl font-bold">The Moose Feed</h1>
              <svg class="w-7 h-7 fill-current" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
            </div>
            <p class="text-purple-100">
              A little dose of Moose! üêæ
            </p>
          </div>

          <div class="p-6">

            <!-- Error State -->
            <div v-if="error" class="text-center py-12">
              <p class="text-red-500 mb-4">‚ö†Ô∏è {{ error }}</p>
              <div class="bg-gray-100 p-4 rounded-lg text-left text-sm">
                <p>Moose is busy at the moment, please come back later!</p>
              </div>
              <button
                @click="fetchContent"
                class="mt-4 px-6 py-2 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition"
              >
                Try Again
              </button>
            </div>

            <!-- Success State -->
            <div v-if="!error" class="space-y-6">
              <!-- Loading State -->
              <div v-if="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2   border-purple-500"></div>
                <p class="mt-4 text-gray-600">
                  Moose is on his way...his legs are short... please hold!
                </p>
              </div>

              <!-- Media -->
              <div class="rounded-2xl overflow-hidden shadow-lg">

              <!-- define :src here so it updates when randomlySelectedMedia.url changes -->
                <video v-if="randomlySelectedMedia.mediaType === 'video'"
                :alt="mediaLoadingPlaceholder"
                class="w-full h-auto object-cover"
                controls
                autoplay
                muted
                loop
                :src="randomlySelectedMedia.url" 
                >
                  <source 
                    :src="randomlySelectedMedia.url" 
                    :type="videoFormat"
                  >
                </video>
                <img v-else
                  :src="randomlySelectedMedia.url"
                  :alt="mediaLoadingPlaceholder"
                  class="w-full h-auto object-cover"
                />
              </div>

              <!-- Dad Joke -->
              <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-2xl border-2 border-yellow-200">
                <p class="text-lg font-semibold text-gray-800 mb-2">
                  Make Moose laugh with a (dog) Dad joke!
                </p>
                <p v-if="jokeLoading" class="text-gray-600 italic">
                  {{jokeLoadingPlaceholder}}
                </p>
                <p v-else class="text-gray-700 italic">
                  {{ joke }}
                </p>
              </div>

              <!-- Refresh Button -->
              <button
                @click="fetchContent"
                class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-semibold hover:from-purple-600 hover:to-pink-600 transition shadow-lg flex items-center justify-center gap-2"
              >
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                I want more!
              </button>
            </div>
          </div>

          <!-- Footer -->
          <div class="bg-gray-50 px-6 py-4 text-center text-sm text-gray-600">
            Made with üíú by a Goose aunt
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          CLOUDINARY_CLOUD_NAME: 'dzuciyiqf',
          CLOUDINARY_FOLDER: 'meese',
          
          images: [],
          videos: [],
          combinedMediaArray: [],
          randomlySelectedMedia: { url: '', mediaType: '', format: '', id: '' },
          joke: '',
          loading: true,
          jokeLoading: false,
          mediaLoadingPlaceholder: 'Moose will be here shortly',
          jokeLoadingPlaceholder: 'Hilarity incoming...',
          error: null,
        };
      },
      computed: {
        videoFormat() {
          if (this.randomlySelectedMedia && this.randomlySelectedMedia.format) {
            return `video/${this.randomlySelectedMedia.format}`;
          }
          return 'video/mp4';
        }
      },
      mounted() {
        this.fetchContent();
      },
      methods: {
        async fetchContent() {
          this.loading = true;
          this.error = null;

          try {
            // If no image/video list yet then fetch them, else just choose another random one
            if(this.combinedMediaArray.length === 0){
              await Promise.all([
                this.fetchAllMooseMedia(),
                this.fetchDadJoke(),
              ]);
              this.chooseRandomMedia()
            } else {
              await this.fetchDadJoke()
              this.chooseRandomMedia()
            } 
          }
          catch (err) {
            this.error = err.message;
            throw new Error(`Fetch Content: ${err.message}`);
          } finally {
            this.loading = false;
          }
        },

        async fetchMooseMedia(mediaType) {
          try {
            // Fetch list of images/videos from Cloudinary folder
            const media = await fetch(
              `https://res.cloudinary.com/${this.CLOUDINARY_CLOUD_NAME}/${mediaType}/list/${this.CLOUDINARY_FOLDER}.json`
            );

            if (!media.ok) {
              throw new Error('Failed to fetch media. Check your Cloudinary settings.');
            }

            const mediaJSON = await media.json();

            if (mediaJSON.resources) {
              mediaJSON.resources.forEach(obj => {
                obj.mediaType = mediaType;
              });

              if (mediaType === 'image') 
                this.images = mediaJSON.resources
              else if (mediaType === 'video')
                this.videos = mediaJSON.resources
            }
          } catch (err) {
            this.error = err;
            throw new Error(`Fetch ${mediaType} error: ${err.message}`);
          }
        },

        async fetchAllMooseMedia() {
          try {
            await Promise.all([
              this.fetchMooseMedia('image'),
              this.fetchMooseMedia('video')
            ]);

            // Combine media into new array
            this.combinedMediaArray = this.images.concat(this.videos);
          } catch (err) {
            this.error = err.message;
            throw new Error(`Fetch all media error: ${err.message}`);
          }
        },

        async chooseRandomMedia() {
          try {
            if (this.combinedMediaArray.length === 0) {
              throw new Error('No images/videos found in the folder.');
            }
            else {
              // Pick a random image/video
              const randomMedia = this.combinedMediaArray[Math.floor(Math.random() * this.combinedMediaArray.length)];

              const randomMediaType = randomMedia.mediaType;
              const randomMediaFormat = randomMedia.format;
              const randomMediaID = randomMedia.public_id;

              // Construct the media URL (optimized for web)
              const mediaUrl = `https://res.cloudinary.com/${this.CLOUDINARY_CLOUD_NAME}/${randomMediaType}/upload/w_800,q_auto,f_auto/${randomMediaID}.${randomMediaFormat}`;
              
              this.randomlySelectedMedia = {
                url: mediaUrl,
                mediaType: randomMediaType,
                format: randomMediaFormat,
                id: randomMediaID
              };
            };
          } catch (err) {
            this.error = err;
            throw new Error(`Choose random media error: ${err.message}`);
          }
        },

        async fetchDadJoke() {
          this.jokeLoading = true;
          try {
            const response = await fetch('https://icanhazdadjoke.com/', {
              headers: {
                'Accept': 'application/json'
              }
            });

            if (!response.ok) {
              throw new Error('Failed to fetch dad joke');
            }

            const data = await response.json();
            this.joke = data.joke;
          } catch (err) {
            this.error = err;
            console.error('Fetch Dad joke error:', err);
          } finally {
            this.jokeLoading = false;
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>